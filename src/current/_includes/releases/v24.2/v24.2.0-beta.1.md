## v24.2.0-beta.1

Release Date: July 18, 2024

{% include releases/new-release-downloads-docker-image.md release=include.release %}

<h3 id="v24-2-0-beta-1-security-updates">Security updates</h3>

- Added `server.jwt_authentication.issuer_custom_ca` cluster setting to support custom root CA for verifying certificates while fetching JWKS from the JWT issuer. [#126062][#126062]

<h3 id="v24-2-0-beta-1-general-changes">General changes</h3>

- Fixed typo in array_functions description [#103156][#103156]
- Job status changes now log events to the OPS channel, indicating the previous status and the new status. [#125319][#125319]

<h3 id="v24-2-0-beta-1-{{-site.data.products.enterprise-}}-edition-changes">{{ site.data.products.enterprise }} edition changes</h3>

- A new public cluster setting `server.oidc_authentication.client.timeout` has been introduced to capture the HTTP client timeout for external calls made during OIDC authentication. [#125767][#125767]
- Add support to the Kafka sink to authenticate with MSK via AWS IAM roles [#125745][#125745]
- We will be adding a new authentication mechanism `authLDAP` to connect to AD servers over LDAPs. Example hba conf entry for this auth method: ```  # TYPE    DATABASE      USER           ADDRESS             METHOD             OPTIONS  # Allow all users to connect to using LDAP authentication with search and bind    host    all           all            all                 ldap               ldapserver=ldap.example.com ldapport=636 "ldapbasedn=ou=users,dc=example,dc=com" "ldapbinddn=cn=readonly,dc=example,dc=com" ldapbindpasswd=readonly_password ldapsearchattribute=uid "ldapsearchfilter=(memberof=cn=cockroachdb_users,ou=groups,dc=example,dc=com)"  # Fallback to password authentication for the root user    host    all           root           0.0.0.0/0          password ``` Example to use for azure AD server: ``` SET cluster setting server.host_based_authentication.configuration = 'host    all           all            all                 ldap ldapserver=azure.dev ldapport=636 "ldapbasedn=OU=AADDC Users,DC=azure,DC=dev" "ldapbinddn=CN=Some User,OU=AADDC Users,DC=azure,DC=dev" ldapbindpasswd=my_pwd ldapsearchattribute=sAMAccountName "ldapsearchfilter=(memberOf=CN=azure-dev-domain-sync-users,OU=AADDC Users,DC=crlcloud,DC=dev)" host    all           root           0.0.0.0/0          password'; ```  We also add the following cluster settings: 1. `server.ldap_authentication.domain_ca` to allow operators to set a custom CA for their domain (i.e. `example.com`). 2. `server.ldap_authentication.client.tls_certificate` and `server.ldap_authentication.client.tls_key` to allow operators to set the client certificate and key for establishing mTLS connection with LDAP server.  Post configuration users should be able to authenticate to LDAP server if: 1. The distinguished name corresponding to their sql username exists (we search for the sql username using `ldapbinddn` and `ldapbindpasswd` in the `ldapbasedn` domain with filter set to `ldapsearchfilter` and `ldapsearchattribute` key having value sql username in db connection string) and we retrieve the DN. 2. Their bind attempt is successful with LDAP server using the retrieved DN and provided ldap password in db connection string.  Example DB client sql login commands. Note `LDAP_SEARCH_VAL` and `SQL_USERNAME` are same. In case of azure `LDAP_SEARCH_VAL` will be value for `sAMAccountName`: 1. ``` cockroach sql --url "postgresql://{LDAP_SEARCH_VAL}:{LDAP_PASSWORD}@{CLUSTER_HOST}:26257" --certs-dir={CLUSTER_CERT_DIR} ``` 2. ``` export PGPASSWORD='LDAP_PASSWORD' cockroach sql --certs-dir=certs --url "postgresql://{LDAP_SEARCH_VAL}@{CLUSTER_HOST}:26257" ``` [#127124][#127124]

<h3 id="v24-2-0-beta-1-sql-language-changes">SQL language changes</h3>

- Implement pgvector encoding, decoding, and operators, without index acceleration. [#124292][#124292]
- The session setting `plan_cache_mode=force_generic_plan` can now be used to force prepared statements to use query plans that are optimized once and reused in future executions without re-optimization, as long as it does not become stale due to schema changes or a collection of new table statistics. The setting takes effect during `EXECUTE` commands. `EXPLAIN ANALYZE` includes a "plan type" field. If a generic query plan is optimized for the current execution, the "plan type" will be "generic, re-optimized". If a generic query plan is reused for the current execution without performing optimization, the "plan type" will be "generic, reused". Otherwise, the "plan type" will be "custom". [#126528][#126528]
- The session setting `plan_cache_mode=auto` can now be used to instruct the system to automatically determine whether to use "custom" or "generic" query plans for the execution of a prepared statement. Custom query plans are optimized on every execution, while generic plans are optimized once and reused on future executions as-is. Generic query plans are beneficial in cases where query optimization contributes significant overhead to the total cost of executing a query. [#127012][#127012]
- SHOW GRANTS for a role shows grants inherited through the implicitly defined public role. [#127086][#127086]

<h3 id="v24-2-0-beta-1-operational-changes">Operational changes</h3>

- For the TELEMETRY channel, TCL `sampled_query` events will now be sampled along with DML statements according to the setting `sql.telemetry.query_sampling.max_event_frequency`. [#126484][#126484]
- The encode-uri command now supports the --certs-dir option as an alternative to passing individual cert paths.  Epic: none. [#126793][#126793]

<h3 id="v24-2-0-beta-1-command-line-changes">Command-line changes</h3>

- The `cockroach node drain` command now has an optional --shutdown flag. When set, the node will shutdown after draining successfully completes. [#126950][#126950]

<h3 id="v24-2-0-beta-1-db-console-changes">DB Console changes</h3>

- Fix expand/collapse icon for tables with expandable rows (on Node Overview page) [#126639][#126639]

<h3 id="v24-2-0-beta-1-bug-fixes">Bug fixes</h3>

- Fast path inserts into regional by row tables with uniqueness constraints are now possible under read-commited isolation. [#126504][#126504]
- `sql.stats.discarded.current` metric was incorrect as it was missing the discarded statement count. It now accurately reports both discarded statement and transaction stats. [#126585][#126585]
- Database overview and db details pages should not crash if the range information is not available. [#126419][#126419]
- Background jobs no longer respect a statement timeout. [#126336][#126336]
- Fixed a bug when creating partial statistics using extremes (which is disabled by default) where it would occasionally fail to merge the new partial stat with existing full stats. This occurs when outer buckets were added to either statistic to account for extra distinct count. [#126830][#126830]
- Fixed a bug when creating partial statistics using extremes (which is disabled by default) where it would result in a merged statistic with inaccurate distinct counts. Also made the merged statistic computation more efficient. [#126830][#126830]
- Fixed bug where zone configs on pkeys disappeared during truncate. [#126531][#126531]

<h3 id="v24-2-0-beta-1-performance-improvements">Performance improvements</h3>

- The query optimizer now generates more efficient plans for queries with clauses like `ORDER BY col ASC NULLS LAST` and `ORDER BY col DESC NULLS FIRST` when `col` is guaranteed to not be `NULL`. [#126685][#126685]

<h3 id="v24-2-0-beta-1-miscellaneous">Miscellaneous</h3>

<h4 id="v24-2-0-beta-1-changes-without-release-note-annotation">Changes without release note annotation</h4>

- [#127166][#127166] [8848bc872][8848bc872] release-24.2: backupccl: skip backup/assume-role on aws (Michael Butler <butler@cockroachlabs.com>)
- [#126708][#126708] [5f01c40e1][5f01c40e1] build: add script to build fuzzers in oss-fuzz (Nukitt <nukit.tailor@cockroachlabs.com>)
- [#126747][#126747] [f1f61a85b][f1f61a85b] roachtest: add manual compaction operation (Bhaskarjyoti Bora <bhaskar.bora@cockroachlabs.com>)
- [#126575][#126575] [ba758c080][ba758c080] kv: add support for Lease.MinExpiration (Nathan VanBenschoten <nvanbenschoten@gmail.com>)
- [#unknown][#unknown] [7d0a01a94][7d0a01a94] Merge pull request from GHSA-xp59-5w32-m8w3 (Ricky Stewart <ricky@cockroachlabs.com>)

<h3 id="v24-2-0-beta-1-doc-updates">Doc updates</h3>

{% comment %}Docs team: Please add these manually.{% endcomment %}

<div class="release-note-contributors" markdown="1">

<h3 id="v24-2-0-beta-1-contributors">Contributors</h3>

This release includes 96 merged PRs by 49 authors.
We would like to thank the following contributors from the CockroachDB community:

- Arjun Mahishi
- Gourav Kumar (first-time contributor, CockroachDB team member)
- Rima Deodhar (first-time contributor, CockroachDB team member)
- Rohit Sanjay (first-time contributor)
- Wenyi Hu (first-time contributor, CockroachDB team member)
- cty123
- lyang24

</div>

[#103156]: https://github.com/cockroachdb/cockroach/pull/103156
[#124292]: https://github.com/cockroachdb/cockroach/pull/124292
[#125319]: https://github.com/cockroachdb/cockroach/pull/125319
[#125745]: https://github.com/cockroachdb/cockroach/pull/125745
[#125767]: https://github.com/cockroachdb/cockroach/pull/125767
[#126062]: https://github.com/cockroachdb/cockroach/pull/126062
[#126336]: https://github.com/cockroachdb/cockroach/pull/126336
[#126419]: https://github.com/cockroachdb/cockroach/pull/126419
[#126484]: https://github.com/cockroachdb/cockroach/pull/126484
[#126504]: https://github.com/cockroachdb/cockroach/pull/126504
[#126528]: https://github.com/cockroachdb/cockroach/pull/126528
[#126531]: https://github.com/cockroachdb/cockroach/pull/126531
[#126575]: https://github.com/cockroachdb/cockroach/pull/126575
[#126585]: https://github.com/cockroachdb/cockroach/pull/126585
[#126639]: https://github.com/cockroachdb/cockroach/pull/126639
[#126685]: https://github.com/cockroachdb/cockroach/pull/126685
[#126708]: https://github.com/cockroachdb/cockroach/pull/126708
[#126747]: https://github.com/cockroachdb/cockroach/pull/126747
[#126793]: https://github.com/cockroachdb/cockroach/pull/126793
[#126830]: https://github.com/cockroachdb/cockroach/pull/126830
[#126950]: https://github.com/cockroachdb/cockroach/pull/126950
[#127012]: https://github.com/cockroachdb/cockroach/pull/127012
[#127086]: https://github.com/cockroachdb/cockroach/pull/127086
[#127124]: https://github.com/cockroachdb/cockroach/pull/127124
[#127166]: https://github.com/cockroachdb/cockroach/pull/127166
[#unknown]: https://github.com/cockroachdb/cockroach/pull/unknown
[5f01c40e1]: https://github.com/cockroachdb/cockroach/commit/5f01c40e1
[7d0a01a94]: https://github.com/cockroachdb/cockroach/commit/7d0a01a94
[8848bc872]: https://github.com/cockroachdb/cockroach/commit/8848bc872
[ba758c080]: https://github.com/cockroachdb/cockroach/commit/ba758c080
[f1f61a85b]: https://github.com/cockroachdb/cockroach/commit/f1f61a85b
